// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

enum Role {
  ADMIN
  MANAGER
  BASIC
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String?
  role         Role    @default(BASIC)
  isActive     Boolean @default(false)

  activationToken String? @unique

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  refreshTokens RefreshToken[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deletedAt])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum OrderStatus {
  CREATED
  PROCESSING
  PAID
  COMPLETED
}

enum PaymentMethod {
  CARD
  CASH
  DIGITAL_WALLET
}

enum RegisterSessionStatus {
  OPEN
  CLOSED
}

model Restaurant {
  id   String @id @default(uuid())
  name String
  slug String @unique

  users            User[]
  products         Product[]
  menus            Menu[]
  categories       Category[]
  orders           Order[]
  registerSessions RegisterSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id   String @id @default(uuid())
  name String // Ej: "Cocina Caliente", "Bebidas", "Postres"

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  price       Decimal @default(0.00)
  stock       Int     @default(0) // Stock Global (Inventario Físico)
  active      Boolean @default(true)
  sku         String?
  imageUrl    String?

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  menuItems  MenuItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Menu {
  id     String  @id @default(uuid())
  name   String // Ej: "Almuerzo Ejecutivo", "Carta Noche"
  active Boolean @default(true)

  startTime  String? // "12:00"
  endTime    String? // "15:00"
  daysOfWeek String? // "MON,TUE,WED,THU,FRI" (comma-separated)

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  items MenuItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenuItem {
  id String @id @default(uuid())

  menuId String
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Configuración Específica del Menú
  price       Decimal? // Precio Override (Si es null, usa Product.price)
  stock       Int?     // Stock Allocation (Si es null, usa Product.stock global sin límite específico)
  sectionName String?  // Sección Visual en la Carta (Ej: "Para Empezar", "el ñandu")
  order       Int      @default(0) // Orden dentro de la sección

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id            String        @id @default(uuid())
  orderNumber   Int
  status        OrderStatus   @default(CREATED)
  paymentMethod PaymentMethod?
  customerEmail String?
  totalAmount   Decimal

  restaurantId      String
  restaurant        Restaurant      @relation(fields: [restaurantId], references: [id])
  registerSessionId String
  registerSession   RegisterSession @relation(fields: [registerSessionId], references: [id])

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId, createdAt])
  @@index([registerSessionId])
}

model OrderItem {
  id        String  @id @default(uuid())
  quantity  Int
  unitPrice Decimal
  subtotal  Decimal
  notes     String?

  orderId    String
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    Product   @relation(fields: [productId], references: [id])
  menuItemId String?
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id])

  createdAt DateTime @default(now())
}

model RegisterSession {
  id              String                @id @default(uuid())
  status          RegisterSessionStatus @default(OPEN)
  lastOrderNumber Int                   @default(0)

  totalSales  Decimal?
  totalOrders Int?
  closedBy    String?

  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  orders Order[]

  openedAt DateTime @default(now())
  closedAt DateTime?

  @@index([restaurantId, status])
}
