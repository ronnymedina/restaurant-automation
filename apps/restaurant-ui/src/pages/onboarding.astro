---
export const prerender = true;
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#667eea] to-[#764ba2] p-8 px-4">
    <div class="bg-white/95 rounded-3xl shadow-2xl w-full max-w-[520px] p-10 relative overflow-hidden">
      <!-- Progress Steps -->
      <div class="flex items-center justify-center mb-10 gap-2">
        <div class="step active flex flex-col items-center gap-2" data-step="1">
          <div class="step-circle w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-semibold text-base transition-all duration-300">1</div>
          <span class="text-xs text-indigo-500 font-semibold">Información</span>
        </div>
        <div class="step-line flex-1 h-[3px] bg-slate-200 max-w-[60px] mb-6 transition-colors duration-300"></div>
        <div class="step flex flex-col items-center gap-2" data-step="2">
          <div class="step-circle w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-semibold text-base transition-all duration-300">2</div>
          <span class="text-xs text-slate-500 font-medium">Menú</span>
        </div>
        <div class="step-line flex-1 h-[3px] bg-slate-200 max-w-[60px] mb-6 transition-colors duration-300"></div>
        <div class="step flex flex-col items-center gap-2" data-step="3">
          <div class="step-circle w-10 h-10 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center font-semibold text-base transition-all duration-300">3</div>
          <span class="text-xs text-slate-500 font-medium">Confirmación</span>
        </div>
      </div>

      <!-- Step 1: Basic Info -->
      <div class="step-content active" id="step1">
        <div class="text-center mb-8">
          <h2 class="text-3xl text-slate-800 mb-2 font-bold">¡Bienvenido!</h2>
          <p class="text-slate-500 text-base">Comienza a digitalizar tu restaurante</p>
        </div>

        <form id="step1Form">
          <div class="mb-6">
            <label for="email" class="block font-semibold text-slate-800 mb-2 text-sm">Correo electrónico</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="tu@email.com"
              required
              class="w-full py-3.5 px-4 border-2 border-slate-200 rounded-xl text-base transition-all bg-white text-slate-800 box-border focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 placeholder:text-slate-400"
            />
          </div>

          <div class="mb-6">
            <label for="restaurantName" class="block font-semibold text-slate-800 mb-2 text-sm">Nombre del restaurante</label>
            <input
              type="text"
              id="restaurantName"
              name="restaurantName"
              placeholder="Mi Restaurante"
              required
              class="w-full py-3.5 px-4 border-2 border-slate-200 rounded-xl text-base transition-all bg-white text-slate-800 box-border focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 placeholder:text-slate-400"
            />
          </div>

          <button type="submit" class="w-full py-4 px-6 bg-indigo-500 text-white border-none rounded-xl text-base font-semibold cursor-pointer flex items-center justify-center gap-2 transition-all hover:bg-indigo-600 hover:-translate-y-0.5">
            Siguiente
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m9 18 6-6-6-6"></path>
            </svg>
          </button>
        </form>
      </div>

      <!-- Step 2: Menu Upload -->
      <div class="step-content" id="step2">
        <div class="text-center mb-8">
          <h2 class="text-3xl text-slate-800 mb-2 font-bold">Tu Menú</h2>
          <p class="text-slate-500 text-base">Sube fotos de tu menú o usa productos demo</p>
        </div>

        <form id="step2Form">
          <div class="upload-area border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center cursor-pointer transition-all relative bg-gray-50 hover:border-indigo-500 hover:bg-indigo-500/5" id="uploadArea">
            <div class="text-indigo-400 mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" x2="12" y1="3" y2="15"></line>
              </svg>
            </div>
            <p class="text-slate-800 font-medium m-0 mb-1">Arrastra tus fotos aquí o haz clic para seleccionar</p>
            <p class="text-slate-500 text-sm m-0">Máximo 10 imágenes del menú</p>
            <input type="file" id="photos" name="photos" multiple accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" />
          </div>

          <div class="flex flex-wrap gap-3 mt-4" id="filePreview"></div>

          <div class="flex gap-4 mt-6">
            <button type="button" class="flex-1 py-4 px-6 bg-white text-slate-500 border-2 border-slate-200 rounded-xl text-base font-semibold cursor-pointer transition-all hover:bg-slate-50 hover:border-slate-500" id="skipBtn">
              Saltar para Demo
            </button>
            <button type="submit" class="flex-1 py-4 px-6 bg-indigo-500 text-white border-none rounded-xl text-base font-semibold cursor-pointer flex items-center justify-center gap-2 transition-all hover:bg-indigo-600 hover:-translate-y-0.5 disabled:bg-slate-300 disabled:cursor-not-allowed" id="uploadBtn" disabled>
              Procesar Menú
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m9 18 6-6-6-6"></path>
              </svg>
            </button>
          </div>
        </form>

        <button type="button" class="bg-transparent border-none text-slate-500 flex items-center gap-1 cursor-pointer text-sm mt-6 p-2 transition-colors hover:text-indigo-500" id="backToStep1">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6"></path>
          </svg>
          Volver
        </button>
      </div>

      <!-- Step 3: Confirmation -->
      <div class="step-content" id="step3">
        <div class="text-center mb-8 py-4">
          <div class="text-emerald-500 mb-4 success-icon-animate">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <h2 class="text-3xl text-slate-800 mb-2 font-bold">¡Registro Exitoso!</h2>
          <p class="text-slate-500 text-base">Tu restaurante ha sido creado</p>
        </div>

        <div class="bg-green-50 rounded-xl p-5 mb-6" id="resultInfo">
          <!-- Filled dynamically -->
        </div>

        <div class="email-notice flex gap-4 p-5 bg-gradient-to-br from-blue-50 to-sky-50 rounded-xl border border-blue-200" id="emailNotice">
          <div class="text-indigo-500 flex-shrink-0" id="emailIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="16" x="2" y="4" rx="2"></rect>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
            </svg>
          </div>
          <div>
            <strong class="text-slate-800 block mb-1" id="emailTitle">Te enviamos un correo</strong>
            <p class="text-slate-500 m-0 text-sm leading-relaxed" id="emailDescription">
              Revisa tu bandeja de entrada para activar tu cuenta y acceder al dashboard.
            </p>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div class="loading-overlay absolute inset-0 bg-white/95 hidden flex-col items-center justify-center gap-4 rounded-3xl z-10" id="loadingOverlay">
        <div class="spinner w-12 h-12 border-4 border-slate-200 border-t-indigo-500 rounded-full"></div>
        <p class="text-slate-500 font-medium">Procesando...</p>
      </div>

      <!-- Error Message -->
      <div class="error-toast absolute bottom-4 left-4 right-4 bg-red-500 text-white p-4 rounded-xl hidden items-center justify-between" id="errorMessage">
        <p class="m-0 font-medium"></p>
        <button type="button" class="bg-transparent border-none text-white text-2xl cursor-pointer p-0 leading-none" id="closeError">×</button>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Step content visibility */
  .step-content {
    display: none;
    animation: fadeIn 0.4s ease;
  }
  .step-content.active {
    display: block;
  }

  /* Loading & error visibility */
  .loading-overlay.visible {
    display: flex;
  }
  .error-toast.visible {
    display: flex;
  }

  /* Upload area dragover */
  .upload-area.dragover {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.05);
  }

  /* Email notice error variant */
  .email-notice.email-error {
    background: linear-gradient(135deg, #fef2f2 0%, #fff1f2 100%);
    border-color: #fecaca;
  }
  .email-notice.email-error .text-indigo-500 {
    color: #ef4444;
  }

  /* File preview items */
  .file-item {
    @apply bg-slate-100 py-2 px-3 rounded-lg text-sm text-slate-800 flex items-center gap-2;
  }
  .file-item .remove-file {
    @apply bg-transparent border-none text-red-500 cursor-pointer text-lg p-0 leading-none;
  }

  /* Result info paragraphs */
  #resultInfo :global(p) {
    @apply my-1 text-slate-800 text-[0.95rem];
  }
  #resultInfo :global(strong) {
    @apply text-emerald-500;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes scaleIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .success-icon-animate {
    animation: scaleIn 0.5s ease;
  }
  .spinner {
    animation: spin 1s linear infinite;
  }
  .error-toast {
    animation: slideUp 0.3s ease;
  }

  @media (max-width: 480px) {
    .step-label-hide {
      display: none;
    }
  }
</style>

<script>
  // State
  let currentStep = 1;
  let formData = {
    email: "",
    restaurantName: "",
    skipProducts: false,
    photos: [] as File[],
  };

  // DOM Elements
  const step1Content = document.getElementById("step1") as HTMLDivElement;
  const step2Content = document.getElementById("step2") as HTMLDivElement;
  const step3Content = document.getElementById("step3") as HTMLDivElement;
  const step1Form = document.getElementById("step1Form") as HTMLFormElement;
  const step2Form = document.getElementById("step2Form") as HTMLFormElement;
  const skipBtn = document.getElementById("skipBtn") as HTMLButtonElement;
  const uploadBtn = document.getElementById("uploadBtn") as HTMLButtonElement;
  const backToStep1 = document.getElementById("backToStep1") as HTMLButtonElement;
  const photosInput = document.getElementById("photos") as HTMLInputElement;
  const uploadArea = document.getElementById("uploadArea") as HTMLDivElement;
  const filePreview = document.getElementById("filePreview") as HTMLDivElement;
  const loadingOverlay = document.getElementById("loadingOverlay") as HTMLDivElement;
  const errorMessage = document.getElementById("errorMessage") as HTMLDivElement;
  const closeError = document.getElementById("closeError") as HTMLButtonElement;
  const resultInfo = document.getElementById("resultInfo") as HTMLDivElement;

  const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:3000";

  function goToStep(step: number) {
    currentStep = step;

    [step1Content, step2Content, step3Content].forEach((el, i) => {
      el.classList.toggle("active", i + 1 === step);
    });

    document.querySelectorAll(".steps-indicator .step, [data-step]").forEach((el) => {
      const stepNum = Number((el as HTMLElement).dataset.step);
      if (!stepNum) return;
      const circle = el.querySelector(".step-circle");
      const label = el.querySelector("span");
      if (stepNum === step) {
        circle?.classList.remove("bg-slate-200", "text-slate-500", "bg-emerald-500");
        circle?.classList.add("bg-indigo-500", "text-white");
        label?.classList.remove("text-slate-500", "font-medium");
        label?.classList.add("text-indigo-500", "font-semibold");
      } else if (stepNum < step) {
        circle?.classList.remove("bg-slate-200", "text-slate-500", "bg-indigo-500");
        circle?.classList.add("bg-emerald-500", "text-white");
        label?.classList.remove("text-indigo-500", "font-semibold");
        label?.classList.add("text-slate-500", "font-medium");
      } else {
        circle?.classList.remove("bg-indigo-500", "bg-emerald-500", "text-white");
        circle?.classList.add("bg-slate-200", "text-slate-500");
        label?.classList.remove("text-indigo-500", "font-semibold");
        label?.classList.add("text-slate-500", "font-medium");
      }
    });

    document.querySelectorAll(".step-line").forEach((el, i) => {
      if (i + 1 < step) {
        el.classList.remove("bg-slate-200");
        el.classList.add("bg-indigo-500");
      } else {
        el.classList.remove("bg-indigo-500");
        el.classList.add("bg-slate-200");
      }
    });
  }

  function setLoading(loading: boolean) {
    loadingOverlay.classList.toggle("visible", loading);
  }

  function showError(message: string) {
    const errorP = errorMessage.querySelector("p") as HTMLParagraphElement;
    errorP.textContent = message;
    errorMessage.classList.add("visible");
    setTimeout(() => {
      errorMessage.classList.remove("visible");
    }, 5000);
  }

  function updateFilePreview() {
    filePreview.innerHTML = "";
    formData.photos.forEach((file, index) => {
      const item = document.createElement("div");
      item.className = "file-item";
      item.innerHTML = `
        <span>${file.name}</span>
        <button type="button" class="remove-file" data-index="${index}">×</button>
      `;
      filePreview.appendChild(item);
    });
    uploadBtn.disabled = formData.photos.length === 0;
  }

  photosInput.addEventListener("change", () => {
    const files = Array.from(photosInput.files || []);
    formData.photos = [...formData.photos, ...files].slice(0, 10);
    updateFilePreview();
  });

  filePreview.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains("remove-file")) {
      const index = parseInt(target.dataset.index || "0");
      formData.photos.splice(index, 1);
      updateFilePreview();
    }
  });

  uploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadArea.classList.add("dragover");
  });

  uploadArea.addEventListener("dragleave", () => {
    uploadArea.classList.remove("dragover");
  });

  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadArea.classList.remove("dragover");
    const files = Array.from(e.dataTransfer?.files || []).filter((f) =>
      f.type.startsWith("image/"),
    );
    formData.photos = [...formData.photos, ...files].slice(0, 10);
    updateFilePreview();
  });

  step1Form.addEventListener("submit", (e) => {
    e.preventDefault();
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const restaurantInput = document.getElementById("restaurantName") as HTMLInputElement;
    formData.email = emailInput.value.trim();
    formData.restaurantName = restaurantInput.value.trim();
    if (!formData.email || !formData.restaurantName) {
      showError("Por favor completa todos los campos");
      return;
    }
    goToStep(2);
  });

  skipBtn.addEventListener("click", async () => {
    formData.skipProducts = true;
    await submitOnboarding();
  });

  step2Form.addEventListener("submit", async (e) => {
    e.preventDefault();
    formData.skipProducts = false;
    await submitOnboarding();
  });

  backToStep1.addEventListener("click", () => {
    goToStep(1);
  });

  closeError.addEventListener("click", () => {
    errorMessage.classList.remove("visible");
  });

  async function submitOnboarding() {
    setLoading(true);

    try {
      const form = new FormData();
      form.append("email", formData.email);
      form.append("restaurantName", formData.restaurantName);
      form.append("skipProducts", String(formData.skipProducts));

      if (!formData.skipProducts) {
        formData.photos.forEach((file) => {
          form.append("photos", file);
        });
      }

      const response = await fetch(`${API_URL}/v1/onboarding/register`, {
        method: "POST",
        body: form,
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        if (errorData?.code) {
          const { getErrorMessage } = await import("../lib/error-messages");
          showError(getErrorMessage(errorData.code));
          return;
        }
        throw new Error("Error al registrar el restaurante");
      }

      const result = await response.json();

      resultInfo.innerHTML = `
        <p><strong>Restaurante:</strong> ${result.restaurant.name}</p>
        <p><strong>ID:</strong> ${result.restaurant.id}</p>
        <p><strong>Productos creados:</strong> ${result.productsCreated}</p>
        <p><strong>Fuente:</strong> ${result.source === "demo" ? "Demo" : result.source === "ai_extracted" ? "IA (Fotos)" : "Ninguno"}</p>
      `;

      const emailNotice = document.getElementById("emailNotice") as HTMLDivElement;
      const emailTitle = document.getElementById("emailTitle") as HTMLElement;
      const emailDescription = document.getElementById("emailDescription") as HTMLParagraphElement;

      if (result.emailSent) {
        emailNotice.classList.remove("email-error");
        emailTitle.textContent = "Te enviamos un correo";
        emailDescription.textContent =
          "Revisa tu bandeja de entrada para activar tu cuenta y acceder al dashboard.";
      } else {
        emailNotice.classList.add("email-error");
        emailTitle.textContent = "No pudimos enviar el correo";
        emailDescription.textContent =
          "Tu cuenta fue creada, pero hubo un problema al enviar el email de activación. Contacta al soporte para activar tu cuenta.";
      }

      goToStep(3);
    } catch (error) {
      console.error("Onboarding error:", error);
      showError("Hubo un error al procesar tu solicitud. Intenta nuevamente.");
    } finally {
      setLoading(false);
    }
  }
</script>
