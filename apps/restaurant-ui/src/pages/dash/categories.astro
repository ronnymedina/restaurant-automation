---
export const prerender = true;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import DataTable from '../../components/dash/DataTable.astro';
---

<DashboardLayout>
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold text-slate-800">Categorías</h2>
      <button
        id="newCategoryBtn"
        class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer border-none"
      >
        Nueva categoría
      </button>
    </div>

    <!-- Create/Edit Form -->
    <div id="categoryForm" class="hidden bg-white rounded-xl border border-slate-200 p-6">
      <h3 id="formTitle" class="text-lg font-semibold text-slate-800 mb-4">Nueva categoría</h3>
      <form id="categoryFormEl" class="flex gap-4 items-end">
        <input type="hidden" id="categoryId" />
        <div class="flex-1">
          <label class="block text-sm font-medium text-slate-700 mb-1">Nombre *</label>
          <input type="text" id="categoryName" required
            class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <button type="submit"
          class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer border-none">
          Guardar
        </button>
        <button type="button" id="cancelBtn"
          class="px-4 py-2 bg-slate-100 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-200 transition-colors cursor-pointer border-none">
          Cancelar
        </button>
      </form>
    </div>

    <DataTable
      tbodyId="categoriesTableBody"
      paginationId="pagination"
      minWidth="400px"
      columns={[
        { label: 'Nombre' },
        { label: 'Fecha de creación', nowrap: true },
        { label: 'Acciones', align: 'right', nowrap: true },
      ]}
    />
  </div>
</DashboardLayout>

<script>
  import { apiFetch } from '../../lib/api';
  import { renderPagination, setTableLoading, setTableEmpty, setTableError } from '../../lib/pagination';

  const COLSPAN = 3;
  let currentPage = 1;
  let editingId: string | null = null;

  const tableBody = document.getElementById('categoriesTableBody')!;
  const categoryForm = document.getElementById('categoryForm')!;
  const formTitle = document.getElementById('formTitle')!;
  const formEl = document.getElementById('categoryFormEl') as HTMLFormElement;
  const paginationEl = document.getElementById('pagination')!;

  async function loadCategories(page = 1) {
    currentPage = page;
    setTableLoading(tableBody, COLSPAN);

    const res = await apiFetch(`/v1/categories?page=${page}&limit=20`);
    if (!res.ok) {
      const msg = res.status === 403 ? 'No tienes permisos para acceder a esta sección' : 'Error al cargar';
      setTableError(tableBody, COLSPAN, msg);
      paginationEl.innerHTML = '';
      return;
    }
    const { data, meta } = await res.json();

    if (data.length === 0) {
      setTableEmpty(tableBody, COLSPAN, 'No hay categorías');
      paginationEl.innerHTML = '';
      return;
    }

    tableBody.innerHTML = data.map((c: any) => `
      <tr class="border-b border-slate-100 hover:bg-slate-50">
        <td class="px-4 py-3 font-medium text-slate-800 max-w-xs truncate">${c.name}</td>
        <td class="px-4 py-3 text-slate-600 whitespace-nowrap">${new Date(c.createdAt).toLocaleDateString()}</td>
        <td class="px-4 py-3 text-right whitespace-nowrap space-x-2">
          <button data-edit-id="${c.id}" data-edit-name="${c.name}" class="edit-btn text-indigo-600 hover:text-indigo-800 cursor-pointer bg-transparent border-none text-sm">Editar</button>
          <button data-delete="${c.id}" class="delete-btn text-red-600 hover:text-red-800 cursor-pointer bg-transparent border-none text-sm">Eliminar</button>
        </td>
      </tr>
    `).join('');

    renderPagination(paginationEl, meta, currentPage, loadCategories);
    bindTableEvents();
  }

  function bindTableEvents() {
    tableBody.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const el = btn as HTMLElement;
        editingId = el.dataset.editId!;
        formTitle.textContent = 'Editar categoría';
        (document.getElementById('categoryId') as HTMLInputElement).value = editingId;
        (document.getElementById('categoryName') as HTMLInputElement).value = el.dataset.editName!;
        categoryForm.classList.remove('hidden');
      });
    });

    tableBody.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = (btn as HTMLElement).dataset.delete!;
        if (!confirm('¿Eliminar esta categoría?')) return;
        await apiFetch(`/v1/categories/${id}`, { method: 'DELETE' });
        loadCategories(currentPage);
      });
    });
  }

  document.getElementById('newCategoryBtn')!.addEventListener('click', () => {
    editingId = null;
    formTitle.textContent = 'Nueva categoría';
    formEl.reset();
    categoryForm.classList.remove('hidden');
  });

  document.getElementById('cancelBtn')!.addEventListener('click', () => {
    categoryForm.classList.add('hidden');
    formEl.reset();
    editingId = null;
  });

  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = (document.getElementById('categoryName') as HTMLInputElement).value;

    if (editingId) {
      await apiFetch(`/v1/categories/${editingId}`, { method: 'PATCH', body: JSON.stringify({ name }) });
    } else {
      await apiFetch('/v1/categories', { method: 'POST', body: JSON.stringify({ name }) });
    }

    categoryForm.classList.add('hidden');
    formEl.reset();
    editingId = null;
    loadCategories(currentPage);
  });

  loadCategories();
</script>
